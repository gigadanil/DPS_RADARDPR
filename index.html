<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–ê–î–ê–† –î–ü–° –î–ù–† ‚Äî –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –®–¢–ê–ë</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU" type="text/javascript"></script>
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        .ui-element { background: rgba(255, 255, 255, 0.98); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); color: #333; z-index: 1000; position: absolute; }
        .panel { top: 15px; left: 15px; width: 240px; padding: 15px; border: 1px solid #333; }
        .chat-container { bottom: 30px; right: 15px; width: 320px; display: flex; flex-direction: column; max-height: 500px; border-radius: 16px; overflow: hidden; }
        .chat-msgs { height: 280px; overflow-y: auto; padding: 15px; font-size: 13px; background: #f8f9fa; display: flex; flex-direction: column; gap: 8px; }
        .msg-cloud { background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #007bff; position: relative; word-wrap: break-word; }
        .msg-admin { border-left-color: #d32f2f; background: #fff5f5; }
        .msg-meta { font-size: 10px; color: #888; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .chat-ctrl { padding: 10px; display: flex; gap: 6px; background: white; border-top: 1px solid #eee; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 6px; color: white; transition: 0.2s; text-align: center; display: block; font-size: 12px; }
        .btn-blue { background: #007bff; } .btn-red { background: #d32f2f; } .btn-orange { background: #f39c12; } .btn-green { background: #2ecc71; } .btn-gray { background: #f0f0f0; color: #333; }
        .rating-box { margin-top: 8px; font-size: 15px; font-weight: bold; color: #1b5e20; background: #c8e6c9; padding: 6px; border-radius: 8px; text-align: center; cursor: pointer; }
        .input-style { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; margin-bottom: 5px; }
        .hidden { display: none !important; }
        #rating-modal { top: 20%; left: 50%; transform: translateX(-50%); width: 280px; padding: 20px; max-height: 50vh; overflow-y: auto; }
        .m-img { width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid #ddd; }
        .admin-badge { background: #d32f2f; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
        .comm-box { margin-top: 10px; background: #f0f0f0; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
        .comm-item { border-bottom: 1px solid #e0e0e0; padding: 3px 0; font-size: 11px; }
    </style>
</head>
<body>

<div id="rating-modal" class="ui-element hidden">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <b>üèÜ –†–µ–π—Ç–∏–Ω–≥ –≤–æ–¥–∏—Ç–µ–ª–µ–π</b>
        <button onclick="toggleBox('rating-modal')" style="border:none; background:none; cursor:pointer; font-size:20px;">√ó</button>
    </div>
    <div id="rating-list"></div>
</div>

<div class="ui-element panel">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <span style="display:flex; align-items:center;">
            <b id="u-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <span id="adm-tag" class="admin-badge" style="display:none;">ADM</span>
        </span>
        <button onclick="toggleBox('p-content')" style="cursor:pointer; border:none; background:none; font-size:18px;">‚ûñ</button>
    </div>
    <div class="rating-box" onclick="showLeaderboard()">üèÜ –ö–∞—Ä–º–∞: <span id="u-rating-val">0</span></div>
    <div id="p-content">
        <button class="btn btn-green" onclick="showLeaderboard()">–û–ë–©–ò–ô –†–ï–ô–¢–ò–ù–ì</button>
        <hr style="border:0; border-top: 1px solid #eee; margin: 10px 0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button class="btn btn-gray" onclick="goTo([48.01, 37.80])">–î–æ–Ω–µ—Ü–∫</button>
            <button class="btn btn-gray" onclick="goTo([48.04, 37.96])">–ú–∞–∫–µ–µ–≤–∫–∞</button>
        </div>
        <div style="font-size: 11px; margin-top: 12px; background: #f8f9fa; padding: 8px; border-radius: 6px;">
            üìç –ü–æ—Å—Ç–æ–≤: <b id="stat-m" style="color:#d32f2f">0</b>
        </div>
        <div id="admin-panel" style="display:none; margin-top:10px; border-top: 2px dashed red; padding-top:10px;">
            <button class="btn btn-red" onclick="adminClearAll()">üî• –û–ß–ò–°–¢–ò–¢–¨ –ö–ê–†–¢–£</button>
        </div>
    </div>
</div>

<div class="ui-element chat-container" id="chat-box">
    <div style="padding:12px; background:#2c3e50; color:white; font-weight:bold; display:flex; justify-content:space-between; align-items: center;">
        <span style="font-size:13px;">üì° –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –ß–ê–¢</span>
        <button onclick="toggleBox('chat-body')" style="color:white; border:none; background:none; font-size:16px; cursor:pointer;">‚ûñ</button>
    </div>
    <div id="chat-body">
        <div id="chat-msgs" class="chat-msgs"></div>
        <div class="chat-ctrl">
            <input type="text" id="chat-in" class="input-style" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendMsg()" class="btn-blue" style="width:45px; margin:0; padding:0; border:none; border-radius:8px; color:white; cursor:pointer;">‚û§</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    const SUPABASE_URL = "https://qvmvrlmsypadsfdyxtqh.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXZybG1zeXBhZHNmZHl4dHFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDM2NDMsImV4cCI6MjA4NTUxOTY0M30.-vBcZlR50YPWotq0dAdocn_HVHcS8jZwtoJjuBixozI"; 
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const BAD_WORDS = ['—Ö–æ—Ö–æ–ª', '—É–∫—Ä–æ–ø', '–≤–æ–π–Ω–∞', '–≤—Å—É', '–∑–µ–ª–µ–Ω—Å–∫–∏–π', '–ø—É—Ç–∏–Ω', '—Ö—É–π', '–ø–∏–¥–æ—Ä', '–±–ª—è', '–µ–±–∞–ª', '—Å—É–∫–∞'];
    const DNR_BOUNDS = { lat: [47.0, 49.2], lon: [36.5, 39.3] }; 

    let myMap, myNick = localStorage.getItem('dnr_nick'), isAdmin = false, lastMsgTime = 0;

    async function checkBan() {
        if (!myNick) return false;
        const { data: ban } = await _sb.from('banned').select('*').eq('nick', myNick).single();
        if (ban) {
            document.body.innerHTML = `<div style="color:white; text-align:center; padding-top:100px; font-family:sans-serif;"><h1>üö´ –î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</h1><p>–í–∞—à –ø–æ–∑—ã–≤–Ω–æ–π <b>${myNick}</b> –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.</p></div>`;
            return true;
        }
        return false;
    }

    const loadMarkers = async () => {
        const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
        if (myMap) {
            myMap.geoObjects.removeAll();
            let count = 0;
            if (markers) {
                markers.forEach(m => { renderM(m, m.id); count++; });
            }
            document.getElementById('stat-m').innerText = count;
        }
    };

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ (—É–±—Ä–∞–Ω–∞ –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Å—Ç—Ä–æ–∫–∏ 127)
    const loadChat = async () => {
        const { data: msgs } = await _sb.from('chat').select('*').order('ts', { ascending: false }).limit(30);
        
        if (!msgs) {
            document.getElementById('chat-msgs').innerHTML = '';
            return;
        }

        const html = msgs.reverse().map(m => {
            const timeStr = new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–µ–π
            let isAdm = false;
            if (m.a === '–î–∂–æ–∫–µ—Ä_–î–ù–†' || m.a === 'Bulgakov_pisatel' || m.role === 'admin') {
                isAdm = true;
            }

            // –ö–ª–∞—Å—Å—ã –∏ —Å—Ç–∏–ª–∏
            let adminClass = isAdm ? 'msg-admin' : '';
            let nameColor = isAdm ? 'color:red' : 'color:#007bff';
            
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–æ–∫—É)
            let delBtn = '';
            if (m.a === myNick || isAdmin) {
                delBtn = `<span onclick="delChatMsg('${m.id}')" style="position:absolute; right:5px; bottom:2px; color:red; cursor:pointer; font-size:9px;">—É–¥–∞–ª–∏—Ç—å</span>`;
            }

            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞ HTML
            return `<div class="msg-cloud ${adminClass}">
                        <div class="msg-meta">
                            <b onclick="adminAction('${m.a}')" style="cursor:pointer; ${nameColor}">${m.a}</b>
                            <span>${timeStr}</span>
                        </div>
                        <div>${m.t}</div>
                        ${delBtn}
                    </div>`;
        }).join('');

        const chatBox = document.getElementById('chat-msgs');
        chatBox.innerHTML = html;
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    const loadRatings = async () => {
        const { data: r } = await _sb.from('ratings').select('*');
        const rObj = {};
        if(r) r.forEach(row => rObj[row.nick] = row.score);
        document.getElementById('u-rating-val').innerText = rObj[myNick] || 0;
        window.allRatings = rObj;
    };

    function isClean(text) {
        if(!text) return true;
        const low = text.toLowerCase();
        for (let word of BAD_WORDS) { if (low.includes(word)) { alert("–ó–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ!"); return false; } }
        return true;
    }

    function isInZone(coords) {
        const [lat, lon] = coords;
        return lat >= DNR_BOUNDS.lat[0] && lat <= DNR_BOUNDS.lat[1] && lon >= DNR_BOUNDS.lon[0] && lon <= DNR_BOUNDS.lon[1];
    }

    async function login() {
        const tg = window.Telegram.WebApp;
        let tgId = "";
        
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            tgId = tg.initDataUnsafe.user.id.toString();
        }

        let userById = null;
        if (tgId) {
            const { data } = await _sb.from('users').select('*').eq('tg_id', tgId).single();
            userById = data;
        }

        if (userById) {
            myNick = userById.nick;
        } else {
            let chosenNick = prompt("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–æ–∑—ã–≤–Ω–æ–π (–ë—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤):");
            const nickRegex = /^[a-zA-Z–∞-—è–ê-–Ø0-9_]+$/;

            while (true) {
                if (!chosenNick) {
                    chosenNick = prompt("–ù–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞:");
                    continue;
                }
                chosenNick = chosenNick.trim();
                if (chosenNick.length < 3 || chosenNick.length > 15) {
                    chosenNick = prompt("–î–ª–∏–Ω–∞ –Ω–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤:");
                } else if (!nickRegex.test(chosenNick)) {
                    chosenNick = prompt("–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ! –ë–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Å–∏–º–≤–æ–ª–æ–≤:");
                } else {
                    const { data: existing } = await _sb.from('users').select('nick').eq('nick', chosenNick).single();
                    if (existing) {
                        chosenNick = prompt("–≠—Ç–æ—Ç –ø–æ–∑—ã–≤–Ω–æ–π —É–∂–µ –∑–∞–Ω—è—Ç! –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –¥—Ä—É–≥–æ–π:");
                    } else {
                        break; 
                    }
                }
            }

            const roleSetting = (chosenNick === '–î–∂–æ–∫–µ—Ä_–î–ù–†' || chosenNick === 'Admin') ? 'admin' : 'driver';
            await _sb.from('users').insert([{ 
                nick: chosenNick, 
                tg_id: tgId || null, 
                role: roleSetting,
                password: "123" 
            }]);
            myNick = chosenNick;
            alert(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–∞—à –ø–æ–∑—ã–≤–Ω–æ–π: ${myNick}`);
        }

        if (await checkBan()) return;

        const { data: userData } = await _sb.from('users').select('*').eq('nick', myNick).single();
        if (userData && (userData.role === 'admin' || myNick === '–î–∂–æ–∫–µ—Ä_–î–ù–†')) {
            isAdmin = true;
        }
        
        localStorage.setItem('dnr_nick', myNick);
        initApp();
    }

    function initApp() {
        ymaps.ready(() => {
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 11, controls: ['zoomControl'] });
            document.getElementById('u-nick').innerText = myNick;
            if (isAdmin) { 
                document.getElementById('adm-tag').style.display = 'inline'; 
                document.getElementById('admin-panel').style.display = 'block'; 
            }
            startListeners();
        });
    }

    async function startListeners() {
        loadMarkers(); loadChat(); loadRatings();
        setInterval(loadMarkers, 10000);
        setInterval(loadChat, 4000);

        myMap.events.add('click', e => {
            const coords = e.get('coords');
            if (!isInZone(coords)) { alert("–¢–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –î–ù–†!"); return; }
            myMap.balloon.open(coords, `
                <div style="color:#333; width:220px;">
                    <b>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É:</b><br>
                    <input id="m-txt" class="input-style" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                    <input id="m-img-url" class="input-style" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                        <button class="btn btn-blue" onclick="saveM([${coords}], 'dps')">üöî –î–ü–°</button>
                        <button class="btn btn-red" onclick="saveM([${coords}], 'spec')">üö® –°–ø–µ—Ü–±–∞—Ç</button>
                        <button class="btn btn-orange" onclick="saveM([${coords}], 'mobile')">üöó –ü–æ–¥–≤–∏–∂–Ω–æ–π</button>
                        <button class="btn btn-purple" onclick="saveM([${coords}], 'check')">üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞</button>
                    </div>
                </div>`);
        });
    }

    async function sendMsg() {
        if (await checkBan()) return;
        const i = document.getElementById('chat-in');
        const val = i.value.trim();
        if (!val || !isClean(val) || Date.now() - lastMsgTime < 2000) return;

        if (val.toLowerCase() === '/admin') {
            i.value = '';
            if (!isAdmin) { systemNotify("–û—Ç–∫–∞–∑: –Ω–µ—Ç –ø—Ä–∞–≤."); return; }
            const { count: uTotal } = await _sb.from('users').select('*', { count: 'exact', head: true });
            const { count: cAct } = await _sb.from('chat').select('*', { count: 'exact', head: true }).gt('ts', Date.now() - 900000);
            systemNotify(`üìä –®–¢–ê–ë: –í—Å–µ–≥–æ —é–∑–µ—Ä–æ–≤: ${uTotal}, –ê–∫—Ç–∏–≤ (15–º): ${cAct}`);
            return;
        }

        await _sb.from('chat').insert([{ a: myNick, t: val, ts: Date.now() }]);
        lastMsgTime = Date.now(); i.value = '';
        loadChat();
    }

    function systemNotify(text) {
        const chatMsgs = document.getElementById('chat-msgs');
        const note = document.createElement('div');
        note.style = "background: #34495e; color: #f1c40f; padding: 8px; border-radius: 8px; font-size: 11px; margin: 5px 0; border-left: 4px solid #f1c40f;";
        note.innerHTML = `<b>–°–ò–°–¢–ï–ú–ê:</b> ${text}`;
        chatMsgs.appendChild(note);
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }

    async function adminAction(target) {
        if (!isAdmin || target === myNick) return;
        if (confirm("–ó–ê–ë–ê–ù–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + target + "?")) {
            await _sb.from('banned').insert([{ nick: target }]);
            alert("–ù–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!");
            loadChat();
        }
    }

    async function saveM(coords, type) {
        if (await checkBan()) return;
        const txt = document.getElementById('m-txt').value || "–†–∞–±–æ—Ç–∞—é—Ç";
        const img = document.getElementById('m-img-url').value.trim();
        if(!isClean(txt) || !isClean(img)) return;
        const now = Date.now();
        await _sb.from('markers').insert([{ coords, type, author: myNick, text: txt, img, ts: now, exp: now + 7200000 }]);
        updateRating(10, myNick);
        myMap.balloon.close();
        loadMarkers();
    }

    function renderM(m, id) {
        const icons = { dps: '2555/2555013.png', spec: '2554/2554978.png', mobile: '809/809998.png', check: '2666/2666505.png' };
        const reportsCount = m.reports ? Object.keys(m.reports).length : 0;
        let commsHtml = m.comments ? Object.values(m.comments).map(c => `<div class="comm-item"><b>${c.a}:</b> ${c.t}</div>`).join('') : "";
        
        const p = new ymaps.Placemark(m.coords, {
            balloonContent: `<div style="width:220px; font-size:12px;">
                <div style="display:flex; justify-content:space-between;"><b>${m.type.toUpperCase()}</b> <small>${new Date(m.ts).toLocaleTimeString()}</small></div>
                <i>${m.text}</i><br>
                ${m.img ? `<img src="${m.img}" class="m-img">` : ''}
                <div class="comm-box">
                    <div id="comms-${id}" style="max-height:50px; overflow-y:auto;">${commsHtml || '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'}</div>
                    <div style="display:flex; gap:3px; margin-top:5px;">
                        <input id="in-com-${id}" class="input-style" style="width:75%; height:20px; font-size:10px; margin:0;" placeholder="–¢–µ–∫—Å—Ç...">
                        <button onclick="addComment('${id}')" style="width:20%; height:22px; cursor:pointer;">+</button>
                    </div>
                </div>
                <button class="btn btn-orange" onclick="reportM('${id}', '${m.author}')">üö´ –û–ë–ú–ê–ù (${reportsCount})</button>
                ${(m.author === myNick || isAdmin) ? `<button class="btn btn-red" onclick="delM('${id}')">–£–î–ê–õ–ò–¢–¨</button>` : ''}
            </div>`
        }, { iconLayout: 'default#image', iconImageHref: 'https://cdn-icons-png.flaticon.com/512/' + icons[m.type], iconImageSize: [34, 34] });
        myMap.geoObjects.add(p);
    }

    async function addComment(mId) {
        if (await checkBan()) return;
        const input = document.getElementById('in-com-' + mId);
        if (!input || !input.value.trim() || !isClean(input.value)) return;
        const { data } = await _sb.from('markers').select('comments').eq('id', mId).single();
        const newComments = data.comments || {};
        const cId = Date.now();
        newComments[cId] = { a: myNick, t: input.value.trim(), ts: cId };
        await _sb.from('markers').update({ comments: newComments }).eq('id', mId);
        input.value = ""; loadMarkers();
    }

    async function reportM(mId, author) {
        if (await checkBan()) return;
        const { data } = await _sb.from('markers').select('reports').eq('id', mId).single();
        const newReports = data.reports || {};
        newReports[myNick.replace(/\s/g, '_')] = true;
        if (Object.keys(newReports).length >= 3) {
            await _sb.from('markers').delete().eq('id', mId);
            updateRating(-50, author);
        } else {
            await _sb.from('markers').update({ reports: newReports }).eq('id', mId);
        }
        loadMarkers();
    }

    async function updateRating(p, user) {
        const { data } = await _sb.from('ratings').select('score').eq('nick', user).single();
        await _sb.from('ratings').upsert({ nick: user, score: (data ? data.score : 0) + p });
        loadRatings();
    }

    async function delM(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { await _sb.from('markers').delete().eq('id', id); loadMarkers(); } }
    async function delChatMsg(id) { await _sb.from('chat').delete().eq('id', id); loadChat(); }
    async function adminClearAll() { if(isAdmin && confirm("–£–î–ê–õ–ò–¢–¨ –í–°–Å?")) { await _sb.from('markers').delete().neq('author', 'none'); loadMarkers(); } }
    function toggleBox(id) { document.getElementById(id).classList.toggle('hidden'); }
    function goTo(c) { myMap.setCenter(c, 12, { duration: 500 }); }
    function showLeaderboard() {
        toggleBox('rating-modal');
        const sorted = Object.entries(window.allRatings || {}).sort((a,b) => b[1] - a[1]);
        document.getElementById('rating-list').innerHTML = sorted.map(([n, s], i) => `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;"><span>${i+1}. <b>${n}</b></span><span style="color:green">${s}</span></div>`).join('');
    }

    login();
</script>
</body>
</html>

