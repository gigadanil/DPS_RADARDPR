<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>РАДАР ДПС ДНР</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU"></script>
    <style>
        body, html { width: 100%; height: 100%; margin: 0; background: #121212; color: white; font-family: sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        .ui-element { position: absolute; z-index: 1000; background: white; color: #333; padding: 10px; border-radius: 8px; }
        .panel { top: 10px; left: 10px; width: 200px; }
        .chat-box { bottom: 20px; right: 10px; width: 280px; height: 350px; display: flex; flex-direction: column; }
        #msgs { flex-grow: 1; overflow-y: auto; background: #f0f0f0; padding: 5px; font-size: 13px; border-radius: 5px; }
        .msg { margin-bottom: 8px; padding: 5px; background: white; border-radius: 5px; border-left: 4px solid #007bff; }
        input { width: 80%; padding: 5px; }
        #error-log { position: absolute; top: 0; width: 100%; background: rgba(255,0,0,0.8); color: white; font-size: 10px; z-index: 9999; }
    </style>
</head>
<body>

<div id="error-log"></div>

<div class="ui-element panel">
    <b>Позывной:</b> <span id="u-nick">...</span><br>
    <b>Карма:</b> <span id="u-rating">0</span>
</div>

<div class="ui-element chat-box">
    <div id="msgs"></div>
    <div style="margin-top:5px; display:flex;">
        <input type="text" id="chat-in" placeholder="Сообщение...">
        <button onclick="sendMsg()">➤</button>
    </div>
</div>

<div id="map"></div>

<script>
    // Ловим ошибки и выводим на экран
    window.onerror = function(m, u, l) {
        document.getElementById('error-log').innerHTML = "Ошибка: " + m + " (линия: " + l + ")";
    };

    const S_URL = "https://qvmvrlmsypadsfdyxtqh.supabase.co";
    const S_KEY = "sb_publishable__RdzKz1jG3I1U3AMrgHNXw_TVOfcPZX";
    const _sb = window.supabase.createClient(S_URL, S_KEY);

    let myMap, myNick = localStorage.getItem('dnr_nick') || "Водитель_" + Math.floor(Math.random()*999);
    localStorage.setItem('dnr_nick', myNick);

    async function init() {
        document.getElementById('u-nick').innerText = myNick;
        
        ymaps.ready(() => {
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 11 });
            loadMarkers();
            loadChat();
            setInterval(loadMarkers, 10000);
            setInterval(loadChat, 4000);
        });
    }

    async function loadMarkers() {
        const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
        if (myMap && markers) {
            myMap.geoObjects.removeAll();
            markers.forEach(m => {
                let p = new ymaps.Placemark(m.coords, { balloonContent: m.text });
                myMap.geoObjects.add(p);
            });
        }
    }

    // Очищенная функция чата без ошибок синтаксиса
    async function loadChat() {
        const { data: msgs } = await _sb.from('chat').select('*').order('ts', { ascending: false }).limit(20);
        if (!msgs) return;

        let html = "";
        msgs.reverse().forEach(m => {
            // Упрощенная сборка строки без вложенных кавычек
            html += '<div class="msg"><b>' + m.a + ':</b> ' + m.t + '</div>';
        });

        const box = document.getElementById('msgs');
        box.innerHTML = html;
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const input = document.getElementById('chat-in');
        const text = input.value.trim();
        if (!text) return;

        await _sb.from('chat').insert([{ a: myNick, t: text, ts: Date.now() }]);
        input.value = "";
        loadChat();
    }

    init();
</script>
</body>
</html>

