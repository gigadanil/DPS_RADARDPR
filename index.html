<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–ê–î–ê–† –î–ü–° –î–ù–† ‚Äî –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –®–¢–ê–ë</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU" type="text/javascript"></script>
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        .ui-element { background: rgba(255, 255, 255, 0.98); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); color: #333; z-index: 1000; position: absolute; }
        .panel { top: 15px; left: 15px; width: 240px; padding: 15px; border: 1px solid #333; }
        .chat-container { bottom: 30px; right: 15px; width: 320px; display: flex; flex-direction: column; max-height: 500px; border-radius: 16px; overflow: hidden; }
        .chat-msgs { height: 280px; overflow-y: auto; padding: 15px; font-size: 13px; background: #f8f9fa; display: flex; flex-direction: column; gap: 8px; }
        .msg-cloud { background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #007bff; position: relative; word-wrap: break-word; }
        .msg-admin { border-left-color: #d32f2f; background: #fff5f5; }
        .msg-meta { font-size: 10px; color: #888; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .chat-ctrl { padding: 10px; display: flex; gap: 6px; background: white; border-top: 1px solid #eee; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 6px; color: white; transition: 0.2s; text-align: center; display: block; font-size: 12px; }
        .btn-blue { background: #007bff; } .btn-red { background: #d32f2f; } .btn-orange { background: #f39c12; } .btn-green { background: #2ecc71; } .btn-gray { background: #f0f0f0; color: #333; }
        .rating-box { margin-top: 8px; font-size: 15px; font-weight: bold; color: #1b5e20; background: #c8e6c9; padding: 6px; border-radius: 8px; text-align: center; cursor: pointer; }
        .input-style { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; margin-bottom: 5px; }
        .hidden { display: none !important; }
        #rating-modal { top: 20%; left: 50%; transform: translateX(-50%); width: 280px; padding: 20px; max-height: 50vh; overflow-y: auto; }
        .m-img { width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid #ddd; }
        .admin-badge { background: #d32f2f; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
        .comm-box { margin-top: 10px; background: #f0f0f0; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
        .comm-item { border-bottom: 1px solid #e0e0e0; padding: 3px 0; font-size: 11px; }
    </style>
</head>
<body>

<div id="rating-modal" class="ui-element hidden">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <b>üèÜ –†–µ–π—Ç–∏–Ω–≥ –≤–æ–¥–∏—Ç–µ–ª–µ–π</b>
        <button onclick="toggleBox('rating-modal')" style="border:none; background:none; cursor:pointer; font-size:20px;">√ó</button>
    </div>
    <div id="rating-list"></div>
</div>

<div class="ui-element panel">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <span style="display:flex; align-items:center;">
            <b id="u-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <span id="adm-tag" class="admin-badge" style="display:none;">ADM</span>
        </span>
        <button onclick="toggleBox('p-content')" style="cursor:pointer; border:none; background:none; font-size:18px;">‚ûñ</button>
    </div>
    <div class="rating-box" onclick="showLeaderboard()">üèÜ –ö–∞—Ä–º–∞: <span id="u-rating-val">0</span></div>
    <div id="p-content">
        <button class="btn btn-green" onclick="showLeaderboard()">–û–ë–©–ò–ô –†–ï–ô–¢–ò–ù–ì</button>
        <hr style="border:0; border-top: 1px solid #eee; margin: 10px 0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button class="btn btn-gray" onclick="goTo([48.01, 37.80])">–î–æ–Ω–µ—Ü–∫</button>
            <button class="btn btn-gray" onclick="goTo([48.04, 37.96])">–ú–∞–∫–µ–µ–≤–∫–∞</button>
        </div>
        <div style="font-size: 11px; margin-top: 12px; background: #f8f9fa; padding: 8px; border-radius: 6px;">
            üìç –ü–æ—Å—Ç–æ–≤: <b id="stat-m" style="color:#d32f2f">0</b>
        </div>
        <div id="admin-panel" style="display:none; margin-top:10px; border-top: 2px dashed red; padding-top:10px;">
            <button class="btn btn-red" onclick="adminClearAll()">üî• –û–ß–ò–°–¢–ò–¢–¨ –ö–ê–†–¢–£</button>
        </div>
    </div>
</div>

<div class="ui-element chat-container" id="chat-box">
    <div style="padding:12px; background:#2c3e50; color:white; font-weight:bold; display:flex; justify-content:space-between; align-items: center;">
        <span style="font-size:13px;">üì° –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –ß–ê–¢</span>
        <button onclick="toggleBox('chat-body')" style="color:white; border:none; background:none; font-size:16px; cursor:pointer;">‚ûñ</button>
    </div>
    <div id="chat-body">
        <div id="chat-msgs" class="chat-msgs"></div>
        <div class="chat-ctrl">
            <input type="text" id="chat-in" class="input-style" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendMsg()" class="btn-blue" style="width:45px; margin:0; padding:0; border:none; border-radius:8px; color:white; cursor:pointer;">‚û§</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE (–î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–≤–æ–∏—Ö —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤)
    const SUPABASE_URL = "https://qvmvrlmsypadsfdyxtqh.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable__RdzKz1jG3I1U3AMrgHNXw_TVOfcPZX"; 
    const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const BAD_WORDS = ['—Ö–æ—Ö–æ–ª', '—É–∫—Ä–æ–ø', '–≤–æ–π–Ω–∞', '–≤—Å—É', '–∑–µ–ª–µ–Ω—Å–∫–∏–π', '–ø—É—Ç–∏–Ω', '—Ö—É–π', '–ø–∏–¥–æ—Ä', '–±–ª—è', '–µ–±–∞–ª', '—Å—É–∫–∞'];
    const DNR_BOUNDS = { lat: [47.0, 49.2], lon: [36.5, 39.3] }; 

    let myMap, myNick = localStorage.getItem('dnr_nick'), isAdmin = false, lastMsgTime = 0;

    function isClean(text) {
        if(!text) return true;
        const low = text.toLowerCase();
        for (let word of BAD_WORDS) { if (low.includes(word)) { alert("–ó–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ!"); return false; } }
        return true;
    }

    function isInZone(coords) {
        const [lat, lon] = coords;
        return lat >= DNR_BOUNDS.lat[0] && lat <= DNR_BOUNDS.lat[1] && lon >= DNR_BOUNDS.lon[0] && lon <= DNR_BOUNDS.lon[1];
    }

    async function login() {
        const tg = window.Telegram.WebApp;
        let tempNick = "";

        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const tgUser = tg.initDataUnsafe.user;
            tempNick = tgUser.username || ("id" + tgUser.id);
            const { data: user } = await _sb.from('users').select('*').eq('nick', tempNick).single();
            if (!user) {
                await _sb.from('users').insert([{ nick: tempNick, password: "123", role: "driver", tg_id: tgUser.id.toString() }]);
            }
            myNick = tempNick;
            localStorage.setItem('dnr_nick', myNick);
        }

        if (!myNick) {
            myNick = prompt("–¢–≤–æ–π –ø–æ–∑—ã–≤–Ω–æ–π:") || "–≠–∫–∏–ø–∞–∂_" + Math.floor(Math.random()*99);
        }

        const { data: ban } = await _sb.from('banned').select('*').eq('nick', myNick).single();
        if (ban) {
            document.body.innerHTML = `<h1 style="color:white; text-align:center; padding-top:50px;">üö´ –î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù<br><small>–í–∞—à –Ω–∏–∫ ${myNick} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</small></h1>`;
            return;
        }

        const { data: userData } = await _sb.from('users').select('*').eq('nick', myNick).single();

        if (userData && userData.password) {
            let savedPass = localStorage.getItem('dnr_pass');
            let pass = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? userData.password.toString() : (savedPass || prompt(`–ù–∏–∫ "${myNick}" –∑–∞—â–∏—â–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:`));
            
            if (pass === userData.password.toString()) {
                localStorage.setItem('dnr_nick', myNick);
                localStorage.setItem('dnr_pass', pass);
                if (userData.role === 'admin') isAdmin = true;
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
                localStorage.removeItem('dnr_nick');
                location.reload();
                return;
            }
        } else {
            localStorage.setItem('dnr_nick', myNick);
        }
        initApp();
    }

    function initApp() {
        ymaps.ready(() => {
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 11, controls: ['zoomControl'] });
            document.getElementById('u-nick').innerText = myNick;
            if (isAdmin) { 
                document.getElementById('adm-tag').style.display = 'inline'; 
                document.getElementById('admin-panel').style.display = 'block'; 
            }
            startListeners();
        });
    }

    async function startListeners() {
        const loadMarkers = async () => {
            const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
            myMap.geoObjects.removeAll();
            let count = 0;
            if (markers) {
                markers.forEach(m => { renderM(m, m.id); count++; });
            }
            document.getElementById('stat-m').innerText = count;
        };

        const loadChat = async () => {
            const { data: msgs } = await _sb.from('chat').select('*').order('ts', { ascending: false }).limit(30);
            const html = msgs ? msgs.reverse().map(m => {
                const timeStr = new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const isAdm = m.a === '–î–∂–æ–∫–µ—Ä_–î–ù–†';
                return `<div class="msg-cloud ${isAdm ? 'msg-admin' : ''}">
                    <div class="msg-meta">
                        <b onclick="adminAction('${m.a}')" style="cursor:pointer; ${isAdm ? 'color:red' : 'color:#007bff'}">${m.a}</b>
                        <span>${timeStr}</span>
                    </div>
                    <div>${m.t}</div>
                    ${(m.a === myNick || isAdmin) ? `<span onclick="delChatMsg('${m.id}')" style="position:absolute; right:5px; bottom:2px; color:red; cursor:pointer; font-size:9px;">—É–¥–∞–ª–∏—Ç—å</span>` : ''}
                </div>`;
            }).join('') : '';
            document.getElementById('chat-msgs').innerHTML = html;
            const cb = document.getElementById('chat-msgs'); cb.scrollTop = cb.scrollHeight;
        };

        const loadRatings = async () => {
            const { data: r } = await _sb.from('ratings').select('*');
            const rObj = {};
            if(r) r.forEach(row => rObj[row.nick] = row.score);
            document.getElementById('u-rating-val').innerText = rObj[myNick] || 0;
            window.allRatings = rObj;
        };

        loadMarkers(); loadChat(); loadRatings();
        setInterval(loadMarkers, 20000);
        setInterval(loadChat, 5000);

        myMap.events.add('click', e => {
            const coords = e.get('coords');
            if (!isInZone(coords)) { alert("–¢–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –î–ù–†!"); return; }
            myMap.balloon.open(coords, `
                <div style="color:#333; width:220px;">
                    <b>–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É:</b><br>
                    <input id="m-txt" class="input-style" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                    <input id="m-img-url" class="input-style" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                        <button class="btn btn-blue" onclick="saveM([${coords}], 'dps')">üöî –î–ü–°</button>
                        <button class="btn btn-red" onclick="saveM([${coords}], 'spec')">üö® –°–ø–µ—Ü–±–∞—Ç</button>
                        <button class="btn btn-orange" onclick="saveM([${coords}], 'mobile')">üöó –ü–æ–¥–≤–∏–∂–Ω–æ–π</button>
                        <button class="btn btn-purple" onclick="saveM([${coords}], 'check')">üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞</button>
                    </div>
                </div>`);
        });
    }

    async function adminAction(target) {
        if (!isAdmin || target === myNick) return;
        if (confirm("–ó–ê–ë–ê–ù–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + target + "?")) {
            await _sb.from('banned').insert([{ nick: target }]);
            alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!");
        }
    }

    async function saveM(coords, type) {
        const txt = document.getElementById('m-txt').value || "–†–∞–±–æ—Ç–∞—é—Ç";
        const img = document.getElementById('m-img-url').value.trim();
        if(!isClean(txt) || !isClean(img)) return;
        const now = Date.now();
        await _sb.from('markers').insert([{ coords, type, author: myNick, text: txt, img, ts: now, exp: now + 7200000 }]);
        updateRating(10, myNick);
        myMap.balloon.close();
    }

    function renderM(m, id) {
        const icons = { dps: '2555/2555013.png', spec: '2554/2554978.png', mobile: '809/809998.png', check: '2666/2666505.png' };
        const reportsCount = m.reports ? Object.keys(m.reports).length : 0;
        let commsHtml = "";
        if (m.comments) {
            commsHtml = Object.values(m.comments).map(c => `<div class="comm-item"><b>${c.a}:</b> ${c.t}</div>`).join('');
        }

        const p = new ymaps.Placemark(m.coords, {
            balloonContent: `<div style="width:220px; font-size:12px;">
                <div style="display:flex; justify-content:space-between;"><b>${m.type.toUpperCase()}</b> <small>${new Date(m.ts).toLocaleTimeString()}</small></div>
                <i>${m.text}</i><br>
                ${m.img ? `<a href="${m.img}" target="_blank"><img src="${m.img}" class="m-img" onerror="this.style.display='none'"></a>` : ''}
                
                <div class="comm-box">
                    <div style="font-weight:bold; font-size:10px; color:#007bff;">üí¨ –£–¢–û–ß–ù–ï–ù–ò–Ø:</div>
                    <div id="comms-${id}" style="max-height:60px; overflow-y:auto; margin-bottom:5px;">${commsHtml || '–ü—É—Å—Ç–æ'}</div>
                    <div style="display:flex; gap:3px;">
                        <input id="in-com-${id}" class="input-style" placeholder="–î–æ–±–∞–≤–∏—Ç—å..." style="margin:0; font-size:10px; height:18px;">
                        <button onclick="addComment('${id}')" style="background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; width:30px;">+</button>
                    </div>
                </div>

                <div style="margin-top:8px; border-top:1px solid #eee; padding-top:8px; display:flex; flex-direction:column; gap:4px;">
                    <button class="btn btn-orange" style="margin:0; padding:4px; font-size:10px;" onclick="reportM('${id}', '${m.author}')">üö´ –û–ë–ú–ê–ù–£–õ (${reportsCount})</button>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <small>–ê–≤—Ç–æ—Ä: ${m.author}</small>
                        ${(m.author === myNick || isAdmin) ? `<button class="btn btn-red" style="padding:2px 8px; font-size:9px; width:auto; margin:0;" onclick="delM('${id}')">–£–î–ê–õ–ò–¢–¨</button>` : ''}
                    </div>
                </div>
            </div>`
        }, { iconLayout: 'default#image', iconImageHref: 'https://cdn-icons-png.flaticon.com/512/' + icons[m.type], iconImageSize: [34, 34] });
        myMap.geoObjects.add(p);
    }

    async function addComment(mId) {
        const input = document.getElementById('in-com-' + mId);
        if (!input.value.trim() || !isClean(input.value)) return;
        
        const { data } = await _sb.from('markers').select('comments').eq('id', mId).single();
        const newComments = data.comments || {};
        const cId = Date.now();
        newComments[cId] = { a: myNick, t: input.value.trim(), ts: cId };
        
        await _sb.from('markers').update({ comments: newComments }).eq('id', mId);
        input.value = "";
    }

    async function reportM(mId, author) {
        if (author === myNick) return;
        const { data } = await _sb.from('markers').select('reports').eq('id', mId).single();
        const newReports = data.reports || {};
        newReports[myNick.replace(/\s/g, '_')] = true;
        
        if (Object.keys(newReports).length >= 3) {
            await _sb.from('markers').delete().eq('id', mId);
            updateRating(-50, author);
        } else {
            await _sb.from('markers').update({ reports: newReports }).eq('id', mId);
        }
    }

    async function sendMsg() {
        const i = document.getElementById('chat-in');
        if (!i.value.trim() || !isClean(i.value) || Date.now() - lastMsgTime < 3000) return;
        await _sb.from('chat').insert([{ a: myNick, t: i.value.trim(), ts: Date.now() }]);
        lastMsgTime = Date.now(); i.value = '';
    }

    async function updateRating(p, user) {
        const { data } = await _sb.from('ratings').select('score').eq('nick', user).single();
        const newScore = (data ? data.score : 0) + p;
        await _sb.from('ratings').upsert({ nick: user, score: newScore });
    }

    async function delM(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) await _sb.from('markers').delete().eq('id', id); }
    async function delChatMsg(id) { await _sb.from('chat').delete().eq('id', id); }
    async function adminClearAll() { if(isAdmin && confirm("–£–î–ê–õ–ò–¢–¨ –í–°–Å?")) await _sb.from('markers').delete().neq('author', 'none'); }
    function toggleBox(id) { document.getElementById(id).classList.toggle('hidden'); }
    function goTo(c) { myMap.setCenter(c, 12, { duration: 500 }); }
    function showLeaderboard() {
        toggleBox('rating-modal');
        const sorted = Object.entries(window.allRatings || {}).sort((a,b) => b[1] - a[1]);
        document.getElementById('rating-list').innerHTML = sorted.map(([n, s], i) => `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;"><span>${i+1}. <b>${n}</b></span><span style="color:green">${s}</span></div>`).join('');
    }

    login();
</script>
</body>
</html>

