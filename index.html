<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–ê–î–ê–† –î–ü–° –î–ù–† ‚Äî –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –®–¢–ê–ë</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU" type="text/javascript"></script>
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #121212; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        .ui-element { background: rgba(255, 255, 255, 0.98); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); color: #333; z-index: 1000; position: absolute; }
        .panel { top: 15px; left: 15px; width: 240px; padding: 15px; border: 1px solid #333; }
        .chat-container { bottom: 30px; right: 15px; width: 320px; display: flex; flex-direction: column; max-height: 500px; border-radius: 16px; overflow: hidden; }
        .chat-msgs { height: 280px; overflow-y: auto; padding: 15px; font-size: 13px; background: #f8f9fa; display: flex; flex-direction: column; gap: 8px; }
        .msg-cloud { background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #007bff; position: relative; word-wrap: break-word; }
        .msg-admin { border-left-color: #d32f2f; background: #fff5f5; }
        .msg-meta { font-size: 10px; color: #888; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .chat-ctrl { padding: 10px; display: flex; gap: 6px; background: white; border-top: 1px solid #eee; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 6px; color: white; transition: 0.2s; text-align: center; display: block; font-size: 12px; }
        .btn-blue { background: #007bff; } .btn-red { background: #d32f2f; } .btn-orange { background: #f39c12; } .btn-green { background: #2ecc71; } .btn-gray { background: #f0f0f0; color: #333; }
        .rating-box { margin-top: 8px; font-size: 15px; font-weight: bold; color: #1b5e20; background: #c8e6c9; padding: 6px; border-radius: 8px; text-align: center; cursor: pointer; }
        .input-style { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; margin-bottom: 5px; }
        .hidden { display: none !important; }
        #rating-modal { top: 20%; left: 50%; transform: translateX(-50%); width: 280px; padding: 20px; max-height: 50vh; overflow-y: auto; }
        .m-img { width: 100%; border-radius: 8px; margin-top: 5px; border: 1px solid #ddd; }
        .admin-badge { background: #d32f2f; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
        .comm-box { margin-top: 10px; background: #f0f0f0; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
        .comm-item { border-bottom: 1px solid #e0e0e0; padding: 3px 0; font-size: 11px; }
    </style>
</head>
<body>

<div id="rating-modal" class="ui-element hidden">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <b>üèÜ –†–µ–π—Ç–∏–Ω–≥ –≤–æ–¥–∏—Ç–µ–ª–µ–π</b>
        <button onclick="toggleBox('rating-modal')" style="border:none; background:none; cursor:pointer; font-size:20px;">√ó</button>
    </div>
    <div id="rating-list"></div>
</div>

<div class="ui-element panel">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <span style="display:flex; align-items:center;">
            <b id="u-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <span id="adm-tag" class="admin-badge" style="display:none;">ADM</span>
        </span>
        <button onclick="toggleBox('p-content')" style="cursor:pointer; border:none; background:none; font-size:18px;">‚ûñ</button>
    </div>
    <div class="rating-box" onclick="showLeaderboard()">üèÜ –ö–∞—Ä–º–∞: <span id="u-rating-val">0</span></div>
    <div id="p-content">
        <button class="btn btn-green" onclick="showLeaderboard()">–û–ë–©–ò–ô –†–ï–ô–¢–ò–ù–ì</button>
        <hr style="border:0; border-top: 1px solid #eee; margin: 10px 0;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button class="btn btn-gray" onclick="goTo([48.01, 37.80])">–î–æ–Ω–µ—Ü–∫</button>
            <button class="btn btn-gray" onclick="goTo([48.04, 37.96])">–ú–∞–∫–µ–µ–≤–∫–∞</button>
        </div>
        <div style="font-size: 11px; margin-top: 12px; background: #f8f9fa; padding: 8px; border-radius: 6px;">
            üìç –ü–æ—Å—Ç–æ–≤: <b id="stat-m" style="color:#d32f2f">0</b>
        </div>
        <div id="admin-panel" style="display:none; margin-top:10px; border-top: 2px dashed red; padding-top:10px;">
            <button class="btn btn-red" onclick="adminClearAll()">üî• –û–ß–ò–°–¢–ò–¢–¨ –ö–ê–†–¢–£</button>
        </div>
    </div>
</div>

<div class="ui-element chat-container" id="chat-box">
    <div style="padding:12px; background:#2c3e50; color:white; font-weight:bold; display:flex; justify-content:space-between; align-items: center;">
        <span style="font-size:13px;">üì° –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –ß–ê–¢</span>
        <button onclick="toggleBox('chat-body')" style="color:white; border:none; background:none; font-size:16px; cursor:pointer;">‚ûñ</button>
    </div>
    <div id="chat-body">
        <div id="chat-msgs" class="chat-msgs"></div>
        <div class="chat-ctrl">
            <input type="text" id="chat-in" class="input-style" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendMsg()" class="btn-blue" style="width:45px; margin:0; padding:0; border:none; border-radius:8px; color:white; cursor:pointer;">‚û§</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    const SUPABASE_URL = "https://qvmvrlmsypadsfdyxtqh.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXZybG1zeXBhZHNmZHl4dHFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDM2NDMsImV4cCI6MjA4NTUxOTY0M30.-vBcZlR50YPWotq0dAdocn_HVHcS8jZwtoJjuBixozI"; 
    const _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const BAD_WORDS = ['—Ö–æ—Ö–æ–ª', '—É–∫—Ä–æ–ø', '–≤–æ–π–Ω–∞', '–≤—Å—É', '–∑–µ–ª–µ–Ω—Å–∫–∏–π', '–ø—É—Ç–∏–Ω', '—Ö—É–π', '–ø–∏–¥–æ—Ä', '–±–ª—è', '–µ–±–∞–ª', '—Å—É–∫–∞'];
    const DNR_BOUNDS = { lat: [47.0, 49.2], lon: [36.5, 39.3] }; 

    let myMap, myNick = localStorage.getItem('dnr_nick'), isAdmin = false, lastMsgTime = 0;

    async function checkBan() {
        if (!myNick) return false;
        const { data: ban } = await _sb.from('banned').select('*').eq('nick', myNick).single();
        if (ban) {
            document.body.innerHTML = `<div style="color:white; text-align:center; padding-top:100px; font-family:sans-serif;"><h1>üö´ –î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</h1></div>`;
            return true;
        }
        return false;
    }

    const loadMarkers = async () => {
        const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
        if (myMap && markers) {
            myMap.geoObjects.removeAll();
            markers.forEach(m => renderM(m, m.id));
            document.getElementById('stat-m').innerText = markers.length;
        }
    };

    const loadChat = async () => {
        const { data: msgs } = await _sb.from('chat').select('*').order('ts', { ascending: false }).limit(30);
        if (!msgs) return;
        const html = msgs.reverse().map(m => {
            const timeStr = new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isAdm = (m.a === '–î–∂–æ–∫–µ—Ä_–î–ù–†' || m.a === 'Bulgakov_pisatel' || m.role === 'admin');
            return `<div class="msg-cloud ${isAdm ? 'msg-admin' : ''}">
                <div class="msg-meta">
                    <b onclick="adminAction('${m.a}')" style="cursor:pointer; ${isAdm ? 'color:red' : 'color:#007bff'}">${m.a}</b>
                    <span>${timeStr}</span>
                </div>
                <div>${m.t}</div>
            </div>`;
        }).join('');
        document.getElementById('chat-msgs').innerHTML = html;
        const cb = document.getElementById('chat-msgs'); cb.scrollTop = cb.scrollHeight;
    };

    const loadRatings = async () => {
        const { data: r } = await _sb.from('ratings').select('*');
        if(!r) return;
        const rObj = {};
        r.forEach(row => rObj[row.nick] = row.score);
        document.getElementById('u-rating-val').innerText = rObj[myNick] || 0;
        window.allRatings = rObj;
    };

    function isClean(text) {
        if(!text) return true;
        const low = text.toLowerCase();
        for (let word of BAD_WORDS) { if (low.includes(word)) return false; }
        return true;
    }

    async function login() {
        const tg = window.Telegram.WebApp;
        let tgId = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.id.toString() : "";

        if (tgId) {
            const { data: user } = await _sb.from('users').select('*').eq('tg_id', tgId).single();
            if (user) { myNick = user.nick; }
        }

        if (!myNick) {
            let chosenNick = prompt("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–æ–∑—ã–≤–Ω–æ–π:");
            if (chosenNick) {
                myNick = chosenNick.trim();
                await _sb.from('users').insert([{ nick: myNick, tg_id: tgId, role: 'driver' }]);
            }
        }

        if (await checkBan()) return;
        
        const { data: userData } = await _sb.from('users').select('*').eq('nick', myNick).single();
        if (userData && userData.role === 'admin') isAdmin = true;

        localStorage.setItem('dnr_nick', myNick);
        initApp();
    }

    function initApp() {
        ymaps.ready(() => {
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 11, controls: ['zoomControl'] });
            document.getElementById('u-nick').innerText = myNick;
            if (isAdmin) {
                document.getElementById('adm-tag').style.display = 'inline';
                document.getElementById('admin-panel').style.display = 'block';
            }
            loadMarkers(); loadChat(); loadRatings();
            setInterval(loadMarkers, 10000);
            setInterval(loadChat, 4000);

            myMap.events.add('click', e => {
                const coords = e.get('coords');
                myMap.balloon.open(coords, `
                    <div style="color:#333; width:220px;">
                        <b>–ù–æ–≤–∞—è –º–µ—Ç–∫–∞:</b><br>
                        <input id="m-txt" class="input-style" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                        <button class="btn btn-blue" onclick="saveM([${coords}], 'dps')">üöî –î–ü–°</button>
                    </div>`);
            });
        });
    }

    async function saveM(coords, type) {
        const txt = document.getElementById('m-txt').value || "–†–∞–±–æ—Ç–∞—é—Ç";
        const now = Date.now();
        await _sb.from('markers').insert([{ coords, type, author: myNick, text: txt, ts: now, exp: now + 7200000 }]);
        myMap.balloon.close();
        loadMarkers();
    }

    function renderM(m, id) {
        const p = new ymaps.Placemark(m.coords, {
            balloonContent: `<b>${m.type.toUpperCase()}</b><br><i>${m.text}</i>`
        }, { iconLayout: 'default#image', iconImageHref: 'https://cdn-icons-png.flaticon.com/512/2555/2555013.png', iconImageSize: [30, 30] });
        myMap.geoObjects.add(p);
    }

    function toggleBox(id) { document.getElementById(id).classList.toggle('hidden'); }
    function goTo(c) { myMap.setCenter(c, 12, { duration: 500 }); }
    function showLeaderboard() {
        toggleBox('rating-modal');
        const sorted = Object.entries(window.allRatings || {}).sort((a,b) => b[1] - a[1]);
        document.getElementById('rating-list').innerHTML = sorted.map(([n, s], i) => `<div>${i+1}. ${n}: ${s}</div>`).join('');
    }

    login();
</script>
</body>
</html>
