<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RADAR TEST</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU"></script>
    <style>
        body { margin: 0; background: #222; color: #fff; font-family: sans-serif; }
        #map { width: 100%; height: 60vh; background: #333; }
        #chat { height: 35vh; overflow-y: auto; padding: 10px; background: #111; font-size: 12px; }
        .msg { border-bottom: 1px solid #333; padding: 5px; }
        .ui { padding: 10px; display: flex; gap: 5px; }
        input { flex: 1; padding: 8px; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="ui">
    <input type="text" id="in" placeholder="Сообщение...">
    <button onclick="send()">ОК</button>
</div>
<div id="chat"></div>

<script>
    // Сразу выводим лог, если что-то упадет
    window.onerror = function(m, u, l) { alert("ОШИБКА: " + m + " в строке " + l); };

    const URL = "https://qvmvrlmsypadsfdyxtqh.supabase.co";
    const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2bXZybG1zeXBhZHNmZHl4dHFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDM2NDMsImV4cCI6MjA4NTUxOTY0M30.-vBcZlR50YPWotq0dAdocn_HVHcS8jZwtoJjuBixozI";
    const _sb = window.supabase.createClient(URL, KEY);
    
    let myMap;
    let myNick = "User_" + Math.floor(Math.random() * 1000);

    function start() {
        console.log("Запуск...");
        ymaps.ready(() => {
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 11 });
            console.log("Карта готова");
            loadChat();
            setInterval(loadChat, 5000);
        });
    }

    async function loadChat() {
        const { data, error } = await _sb.from('chat').select('*').order('ts', { ascending: false }).limit(20);
        if (error) { console.error(error); return; }
        
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = ""; // Полная очистка
        
        if (data) {
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'msg';
                div.innerHTML = "<b>" + item.a + ":</b> " + item.t;
                chatDiv.appendChild(div);
            });
        }
    }

    async function send() {
        const el = document.getElementById('in');
        const val = el.value.trim();
        if (!val) return;
        
        await _sb.from('chat').insert([{ a: myNick, t: val, ts: Date.now() }]);
        el.value = "";
        loadChat();
    }

    start();
</script>
</body>
</html>
