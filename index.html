<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–†–ê–î–ê–† –î–ü–° –î–ù–†</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=7f7db9e2-0eff-47d4-98d3-59b326552ed7&lang=ru_RU" type="text/javascript"></script>
    
    <style>
        body, html { width: 100%; height: 100%; margin: 0; padding: 0; font-family: sans-serif; background: #121212; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        .ui-element { background: rgba(255, 255, 255, 0.98); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); color: #333; z-index: 1000; position: absolute; }
        .panel { top: 15px; left: 15px; width: 240px; padding: 15px; }
        .chat-container { bottom: 30px; right: 15px; width: 320px; display: flex; flex-direction: column; max-height: 500px; border-radius: 16px; overflow: hidden; }
        .chat-msgs { height: 280px; overflow-y: auto; padding: 15px; background: #f8f9fa; display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
        .msg-cloud { background: white; padding: 8px; border-radius: 12px; border-left: 4px solid #007bff; }
        .chat-ctrl { padding: 10px; display: flex; gap: 6px; background: white; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 6px; color: white; font-size: 12px; }
        .btn-blue { background: #007bff; } .btn-red { background: #d32f2f; } .btn-orange { background: #f39c12; } .btn-green { background: #2ecc71; }
        .input-style { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="ui-element panel">
    <b id="u-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
    <div style="background: #c8e6c9; padding: 6px; border-radius: 8px; text-align: center; margin: 8px 0; font-weight: bold;">
        üèÜ –ö–∞—Ä–º–∞: <span id="u-rating-val">0</span>
    </div>
    <div id="p-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button class="btn btn-blue" style="background:#666" onclick="goTo([48.01, 37.80])">–î–æ–Ω–µ—Ü–∫</button>
            <button class="btn btn-blue" style="background:#666" onclick="goTo([48.04, 37.96])">–ú–∞–∫–µ–µ–≤–∫–∞</button>
        </div>
        <p style="font-size: 11px;">üìç –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤: <b id="stat-m">0</b></p>
    </div>
</div>

<div class="ui-element chat-container">
    <div style="padding:10px; background:#2c3e50; color:white; font-size:12px; font-weight:bold;">üì° –û–ü–ï–†–ê–¢–ò–í–ù–´–ô –ß–ê–¢</div>
    <div id="chat-msgs" class="chat-msgs"></div>
    <div class="chat-ctrl">
        <input type="text" id="chat-in" class="input-style" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button onclick="sendMsg()" class="btn-blue" style="width:40px; margin:0">‚û§</button>
    </div>
</div>

<div id="map"></div>

<script>
    // –ü–æ–¥—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∞–∫—Ç—É–∞–ª—å–Ω—ã–π SUPABASE_KEY –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
    const SUPABASE_URL = "https://qvmvrlmsypadsfdyxtqh.supabase.co";
    const SUPABASE_KEY = "sb_publishable__RdzKz1jG3I1U3AMrgHNXw_TVOfcPZX"; 
    const _sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myMap, myNick = localStorage.getItem('dnr_nick') || "–≠–∫–∏–ø–∞–∂_" + Math.floor(Math.random()*99);

    async function init() {
        ymaps.ready(() => {
            myMap = new ymaps.Map("map", { center: [48.01, 37.80], zoom: 11, controls: [] });
            document.getElementById('u-nick').innerText = myNick;
            
            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
            myMap.events.add('click', e => {
                const coords = e.get('coords');
                myMap.balloon.open(coords, `
                    <div style="padding:10px; color:#333">
                        <b>–ß—Ç–æ —Ç—É—Ç?</b><br>
                        <input id="m-txt" class="input-style" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."><br>
                        <button class="btn btn-blue" onclick="saveM([${coords}], 'dps')">üöî –î–ü–°</button>
                        <button class="btn btn-orange" onclick="saveM([${coords}], 'mobile')">üöó –ü–æ–¥–≤–∏–∂–Ω–æ–π</button>
                    </div>`);
            });

            startSync();
        });
    }

    async function saveM(coords, type) {
        const txt = document.getElementById('m-txt').value || "–°—Ç–æ—è—Ç";
        const now = Date.now();
        await _sb.from('markers').insert([{ 
            coords, type, text: txt, author: myNick, ts: now, exp: now + 7200000 
        }]);
        myMap.balloon.close();
        loadData(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º
    }

    async function sendMsg() {
        const input = document.getElementById('chat-in');
        if (!input.value.trim()) return;
        await _sb.from('chat').insert([{ a: myNick, t: input.value, ts: Date.now() }]);
        input.value = "";
        loadData(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º
    }

    async function loadData() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫ (—Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –Ω–µ –∏—Å—Ç–µ–∫–ª–∏)
        const { data: markers } = await _sb.from('markers').select('*').gt('exp', Date.now());
        if (markers) {
            myMap.geoObjects.removeAll();
            markers.forEach(m => {
                const p = new ymaps.Placemark(m.coords, {
                    balloonContent: `<b>${m.text}</b><br><small>–û—Ç: ${m.author}</small>`
                }, { preset: m.type === 'dps' ? 'islands#redPoliceIcon' : 'islands#orangeAutoIcon' });
                myMap.geoObjects.add(p);
            });
            document.getElementById('stat-m').innerText = markers.length;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
        const { data: msgs } = await _sb.from('chat').select('*').order('ts', { ascending: false }).limit(20);
        if (msgs) {
            const html = msgs.reverse().map(m => `
                <div class="msg-cloud">
                    <div style="font-size:10px; color:#888"><b>${m.a}</b></div>
                    ${m.t}
                </div>`).join('');
            const box = document.getElementById('chat-msgs');
            box.innerHTML = html;
            box.scrollTop = box.scrollHeight;
        }
    }

    function startSync() {
        loadData();
        setInterval(loadData, 3000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
    }

    function goTo(c) { myMap.setCenter(c, 12, { duration: 500 }); }

    init();
</script>
</body>
</html>
